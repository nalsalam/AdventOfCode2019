# day 7 part 1 (no feedback) with R6 

library(R6)

Amp <- R6Class("Amp",
  public = list(
    pgm = NULL,
    ptr = NULL,
    phase = NULL,
    halt = NULL,
    
    # initialize the Amp with a phase setting
    initialize = function(pgm, ptr = 0, phase) {
      # stopifnot(phase %in% 0:4)
      self$pgm <- pgm
      self$ptr <- ptr
      self$phase <- phase
      
      self$pgm[self$pgm[2] + 1] <- self$phase
      self$ptr <- self$ptr + 2
    },
    
    # No feedback, single input
    # run until Opcode is 99
    # return the last output produced
    
    run = function(input) {
      
      while(TRUE) {
        
        Opcode <- self$pgm[self$ptr + 1] %% 100
        if(Opcode == 99) {
          self$halt <- TRUE
          break()
        }
        
        modes <- 
          self$pgm[self$ptr + 1] %/% (10 * 10^c(1:3)) %% (10^c(1:3)) # vector of parameter modes
        values <- 
          dplyr::if_else(
            modes == 0,
              c(self$pgm[self$ptr + 2] + 1, self$pgm[self$ptr + 3] + 1, self$pgm[self$ptr + 4] + 1), # position mode 
              c(self$ptr + 2, self$ptr + 3, self$ptr + 4) # immediate mode
          )
        
        if(Opcode == 1) {
          self$pgm[values[3]] <- self$pgm[values[1]] + self$pgm[values[2]]
          self$ptr <- self$ptr + 4
          
        } else if(Opcode == 2) {
          self$pgm[values[3]] <- self$pgm[values[1]] * self$pgm[values[2]]
          self$ptr <- self$ptr + 4
          
        } else if(Opcode == 3) {
          # simpler than feedback version
          self$pgm[values[1]] <- input
          self$ptr <- self$ptr + 2
            
        } else if(Opcode == 4) {
          output <- self$pgm[values[1]]
          self$ptr <- self$ptr + 2
          
        } else if(Opcode == 5) {
          if(self$pgm[values[1]] != 0) self$ptr <- self$pgm[values[2]] 
          else self$ptr <- self$ptr + 3
          
        } else if(Opcode == 6) {
          if(self$pgm[values[1]] == 0) self$ptr <- self$pgm[values[2]]
          else self$ptr <- self$ptr + 3
          
        } else if(Opcode == 7) {
          if(self$pgm[values[1]] < self$pgm[values[2]]) self$pgm[values[3]] <- 1
          else self$pgm[values[3]] <- 0
          self$ptr <- self$ptr + 4
          
        } else if(Opcode == 8) {
          if(self$pgm[values[1]] == self$pgm[values[2]]) self$pgm[values[3]] <- 1
          else self$pgm[values[3]] <- 0
          self$ptr <- self$ptr + 4  
          
        } else {
          print(paste("Invalid instruction at position ", self$ptr))
        }
      }
      
      # return(paste("Output: ", output)) # For day 5
      return(output) # For day 7, part 1
      }
  )
)

TEST <- c(3,225,1,225,6,6,1100,1,238,225,104,0,1002,114,19,224,1001,224,-646,224,4,224,102,8,223,223,1001,224,7,224,1,223,224,223,1101,40,62,225,1101,60,38,225,1101,30,29,225,2,195,148,224,1001,224,-40,224,4,224,1002,223,8,223,101,2,224,224,1,224,223,223,1001,143,40,224,101,-125,224,224,4,224,1002,223,8,223,1001,224,3,224,1,224,223,223,101,29,139,224,1001,224,-99,224,4,224,1002,223,8,223,1001,224,2,224,1,224,223,223,1101,14,34,225,102,57,39,224,101,-3420,224,224,4,224,102,8,223,223,1001,224,7,224,1,223,224,223,1101,70,40,225,1102,85,69,225,1102,94,5,225,1,36,43,224,101,-92,224,224,4,224,1002,223,8,223,101,1,224,224,1,224,223,223,1102,94,24,224,1001,224,-2256,224,4,224,102,8,223,223,1001,224,1,224,1,223,224,223,1102,8,13,225,1101,36,65,224,1001,224,-101,224,4,224,102,8,223,223,101,3,224,224,1,223,224,223,4,223,99,0,0,0,677,0,0,0,0,0,0,0,0,0,0,0,1105,0,99999,1105,227,247,1105,1,99999,1005,227,99999,1005,0,256,1105,1,99999,1106,227,99999,1106,0,265,1105,1,99999,1006,0,99999,1006,227,274,1105,1,99999,1105,1,280,1105,1,99999,1,225,225,225,1101,294,0,0,105,1,0,1105,1,99999,1106,0,300,1105,1,99999,1,225,225,225,1101,314,0,0,106,0,0,1105,1,99999,8,677,226,224,1002,223,2,223,1006,224,329,1001,223,1,223,1108,226,226,224,1002,223,2,223,1005,224,344,101,1,223,223,1108,226,677,224,1002,223,2,223,1006,224,359,101,1,223,223,107,226,226,224,1002,223,2,223,1005,224,374,101,1,223,223,1107,226,226,224,1002,223,2,223,1005,224,389,101,1,223,223,107,677,677,224,102,2,223,223,1006,224,404,101,1,223,223,1008,226,226,224,1002,223,2,223,1006,224,419,101,1,223,223,108,677,226,224,1002,223,2,223,1006,224,434,101,1,223,223,1108,677,226,224,102,2,223,223,1005,224,449,101,1,223,223,1008,677,226,224,102,2,223,223,1006,224,464,1001,223,1,223,108,677,677,224,102,2,223,223,1005,224,479,101,1,223,223,7,677,677,224,102,2,223,223,1005,224,494,1001,223,1,223,8,226,677,224,102,2,223,223,1006,224,509,101,1,223,223,107,677,226,224,1002,223,2,223,1005,224,524,1001,223,1,223,7,677,226,224,1002,223,2,223,1005,224,539,1001,223,1,223,1007,226,677,224,1002,223,2,223,1005,224,554,1001,223,1,223,8,677,677,224,102,2,223,223,1006,224,569,101,1,223,223,7,226,677,224,102,2,223,223,1006,224,584,1001,223,1,223,1008,677,677,224,102,2,223,223,1005,224,599,101,1,223,223,1007,677,677,224,1002,223,2,223,1006,224,614,101,1,223,223,1107,677,226,224,1002,223,2,223,1006,224,629,101,1,223,223,1107,226,677,224,1002,223,2,223,1006,224,644,101,1,223,223,1007,226,226,224,102,2,223,223,1005,224,659,1001,223,1,223,108,226,226,224,102,2,223,223,1006,224,674,101,1,223,223,4,223,99,226)
# Day 5, part 1 -- give it ID = 1 as the input and then run with no input
Amp$new(TEST, phase = 1)$run()  # "Output:  15314507"
# Day 5, part 2 -- give it ID = 5 as the input and then run with no input
Amp$new(TEST, phase = 5)$run() # "Output:  652726"


# Day 7, part 1
# No feedback
# Change return to provide an number otherwise, no changes
# Amplifier program

# Some tests

thruster <- function(ACT, phase) {
  A <- Amp$new(ACT, phase = phase[1])$run(0)
  B <- Amp$new(ACT, phase = phase[2])$run(A)
  C <- Amp$new(ACT, phase = phase[3])$run(B) 
  D <- Amp$new(ACT, phase = phase[4])$run(C)   
  E <- Amp$new(ACT, phase = phase[5])$run(D)
  return(E)
}
thruster(c(3,15,3,16,1002,16,10,16,1,16,15,15,4,15,99,0,0), phase = c(4,3,2,1,0))
thruster(c(3,23,3,24,1002,24,10,24,1002,23,-1,23,101,5,23,23,1,24,23,23,4,23,99,0,0), phase = c(0,1,2,3,4))
thruster(c(3,31,3,32,1002,32,10,32,1001,31,-2,31,1007,31,0,33,1002,33,7,33,1,33,31,31,1,32,31,31,4,31,99,0,0,0), phase = c(1,0,4,3,2))

ACT <- c(3,8,1001,8,10,8,105,1,0,0,21,34,59,68,89,102,183,264,345,426,99999,3,9,102,5,9,9,1001,9,5,9,4,9,99,3,9,101,3,9,9,1002,9,5,9,101,5,9,9,1002,9,3,9,1001,9,5,9,4,9,99,3,9,101,5,9,9,4,9,99,3,9,102,4,9,9,101,3,9,9,102,5,9,9,101,4,9,9,4,9,99,3,9,1002,9,5,9,1001,9,2,9,4,9,99,3,9,1002,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,99,3,9,1001,9,1,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,101,1,9,9,4,9,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,101,1,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,2,9,4,9,99,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,101,1,9,9,4,9,3,9,1001,9,1,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,99,3,9,101,1,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,101,2,9,9,4,9,99,3,9,1001,9,1,9,4,9,3,9,1001,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,1001,9,1,9,4,9,3,9,1001,9,2,9,4,9,3,9,1002,9,2,9,4,9,99)

perm <- function(v) {
  n <- length(v)
  if (n == 1) v
  else {
    X <- NULL
    for (i in 1:n) X <- rbind(X, cbind(v[i], perm(v[-i])))
    X
  }
}
phase_sequence <- perm(0:4)


thruster_output <- as.vector(120)
i <- 1 
while(i <= 120) {
  thruster_output[i] <- thruster(ACT, phase_sequence[i, ])
  cat(i)
  i <- i + 1
  cat(",")
}
max(thruster_output) # 70597

# Success!!



